<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>GlyGen Sandbox</title>
	
<link rel="icon" href="../svg/sbSmall.svg" type="image/icon type">
<link rel="stylesheet" type="text/css" href="../css/explore.css">
	
<script src="../js/sbheader.js"></script>
	
<script src="../js/jquery-3.5.1.min.js"></script>
<script src="../js/json2svg_v1.4.js"></script>

<style>

#imgDiv {
	position: fixed;
	z-index: 88;
	right: 20px;
	top: 60px;
	width: 800px;
	border-style: none;
	text-align: center;
}
		
#iDiv {
	position: relative;
	z-index: 88;
	top: 20px;
	width: 100%;
	border-style: none;
	text-align: center;
}

#listDiv {
	position: absolute;
	z-index: 88;
	left: 20px;
	top: 60px;
	width: 200px;
	border-style: none;
	text-align: left;
}

#rules_table td {
	text-align: left;
	padding-left: 10px;
	padding-right: 10px;
}
	
#rules_table tr:nth-child(even) {
	background-color: rgb(228,235,240);
}
	
#rule_select_table {
		text-align: left;
}
	
#saved_rules td {
	text-align: left;
	padding-left: 10px;
	padding-right: 10px;
}
	
#saved_rules tr:nth-child(even) {
	background-color: rgb(228,235,240);
}

</style>	
	
<script>
var tCount = 0;

function initialize() {
	console.log("##### Initializing #####");
	setupAnimation('logo_svg', 'header');
	fetchConfiguration(configPath);
	$("#check_it").click(function() {
		getRules(true);
	});
	$("#generate_rule").click(function() {
		generateRule();
	});
	$("#show_rule_list").click(function() {
		showRuleList();
	});
	console.log("list URL is " + listPath);
	
	var arg = window.location.search.substring(1).split("&")[0];
	var a = arg.split("=");
	if (arg.length > 1) {
		$("#resid").val(a[a.length - 1]);
		getRules(true);
	}
} // end of function initialize()

	
// additional stuff
// global vars	
// use next line when running under MAMP
var listPath = "list.php";
var glycanPath = "glycan-v4.php";
var submitPath = "submitRules.php";
var configPath = "../json/sugars.json";
var v =  5;
var svgEncoding = "";
var newRuleID = null;
var newRule = null; // object
var newRuleStr = ""; // string
var allRuleStrs = new Array(); // string[]
var allRules = new Object(); // object[]
allRules['curator'] = "";
allRules['curator_pw'] = "";
allRules['data'] = new Array();
var jsonRules = "";
	
	
function downloadSVG(a) {
	var s = document.createElement("a");
	// svgEncoding is a global variable
	s.href = 'data:text/svg,' + encodeURIComponent(svgEncoding);
	s.download = a + ".svg";
	s.click();
} // end of function downloadSVG()
	
	
function showList(selectedGlycans, resID) {
	var ld = $("#listDiv");
	var listHTML = "<h3>Glycans Containing Residue " + resID + "</h3><table>\n";
	for (var i = 0; i < selectedGlycans.length; i++) {
		listHTML += "<tr>\n<td><a href=\"javascript:showImage('" +
			selectedGlycans[i].glytoucan_ac + "', '" + resID + "');\">" +
			selectedGlycans[i].glytoucan_ac + "</a></td>\n</tr>\n"
	}
	listHTML += "</table>";
	ld.html(listHTML);
	showImage(selectedGlycans[0].glytoucan_ac, resID);
} // end of function showList()
	

	
	
function showImage(accession, resID) {
	$.get(glycanPath,
	{
		ac: accession,
		type: 'json'
	},
	function(result){
		if (v > 5) {
			console.log(" the URL " + glycanPath + 
				" returned this json data for " + accession + "\n  " + result.toString());
		}

		var jsonResult = JSON.parse(result);
		if (v > 5) console.log(result);
		// svgEncoding is a global variable
		svgEncoding = generateOneSVG(accession, jsonResult);
		
		var sd = $("#iDiv");
		sd.html("<h3>Structure " + accession + " contains residue " + resID + " (highlighted)</h3>")
		sd.append(svgEncoding);
		
		var bStr = "<br>\
	<form action=\"../explore.html\" method=\"get\" target=\"_blank\">\
		<label for=\"fname\">GlyTouCan Accession:</label>\
		<input type=\"text\" id=\"focus\" name=\"focus\" size=\"10\">\
		<br><input type=\"submit\" value=\"Explore This Glycan Structure\">\
	</form>";
		
		
		bStr += "<br><input type='button' value='Dowload SVG Image'" +
			 "onClick=\"downloadSVG('" + accession + "')\">";

		sd.append(bStr);
		
		$("#focus").val(accession);
		
		var  clickableSet = sd.find('[class$=_node]').children();
		var  edgeSet = sd.find('[class$=_edge]').children();
		var canvasSet = sd.find("[id^=C-]");
		$.merge(clickableSet, edgeSet);
		$.merge(clickableSet, canvasSet);
		if (v > 8) console.log("clickableSet.length: " + clickableSet.length);
		
		clickableSet.each(function( index ) {
			// default opacity in this context is 0.4
			$(this).css('opacity', 0.4);
			var id = $(this).attr("id");
			// the id of each svg object is complex,
			//    containing an accession, a resID, and a type

			var selectedID = "R-" + accession + ":" + resID;
			if (id == selectedID) {
				//  grey-out all residues/links, but except focus residue
				$(this).css('opacity', 1.0);
			}
		});
		
	})			
	.fail(function() {
		unavailable.push("JSON data for " + accession);
		console.log("File " + glycanPath + " not found");
		dataAvailable = false;
	});
	
} // end of function showImage()	


function fetchConfiguration(theURL) {
	$.get(theURL, 
	function(result){
		if (v > 3) {
			console.log("  fetched sugar configuration data from " +
							theURL + ":\n  " + result);
		}
		if (theURL.includes(".json")) {
			// jquery automatically parses files with extension '.json'
			conf = result;
		} else {
			// JSON.parse is not automatically invoked
			conf = JSON.parse(result);
		}
	});
	
} // end of function fetchConfiguration()
	
function fetchList(resID) {
	var mode = "res";
	var selectedGlycans = "";
	if (v > 3) console.log("Fetching list from " + listPath + " using parameters " + resID + " and " + mode);
	$.get(listPath,
	{
		par: resID,
		mode: mode
	},
	function(result){
		
		if (v > 3) {
			console.log("  fetched list from " +
							listPath + ":\n  " + result);
		}
		
		selectedGlycans = JSON.parse(result);
		showList(selectedGlycans, resID);	

	});
	
} // end of function fetchList()
	
	
function generateOneSVG(ac, jsonResult) {
	theTree = plantTree(jsonResult);
	accession = ac;
	svgEncoding = layout(theTree); // modifies trees object
	return svgEncoding;
} // end of function generateOneSVG()

	
// plantTree() returns a JS data object containing only those elements 
//   required for encoding the SVG image of the glycan
//  treeData is a JS data object directly produced when JSON.parse()
// 	is applied to the input JSON data
function plantTree(treeData) {
	if (v > 5) console.log("@@@ planting tree\n" +
									  treeData['glytoucan_ac']);
	//  extract information and populate the object 'tree'
	// tree is the data object consumed by json2svg
	var tree = new Array();
	tree['accession'] = treeData.glytoucan_ac;
	tree['nodes'] = new Array();
	// treeData is original data from json file 
	//   for this example, the nodes are called 'residues' in the original
	var residues = treeData.residues; // residues is the local name of the array
	for (var i=0; i < residues.length; i++) {
		var node = new Array(); // this array will be an element of object 'tree'
		var nameParts = residues[i].name.split("-");
		node["node_id"] = residues[i].residue_id;
		node["name"] = nameParts[0];
		node["substituent"] = "";
		if (nameParts.length > 1) { // the residue has a substituent
			node["substituent"] = nameParts[1];
		}
		node["parent_id"] = residues[i].parent_id;
		node["anomer"] = residues[i].anomer;
		node["absolute"] = residues[i].absolute;
		node["ring"] = residues[i].ring;
		node["site"] = residues[i].site;
		node['touched'] = false;
		tree['nodes'].push(node);
	}
	return (tree);
} // end of function plantTree()

	
function getRules(showEm) {
	var resid = $("#resid").val();
	if (showEm) $("#ruleDiv").html("<p>Getting rules for " + resid + "</p>");
	
	var thisURL = "" + window.location; // force thisURL to be a String
	var urlSplit = thisURL.split('/');
	var urlBase = "";
	for (var i = 0; i < (urlSplit.length - 1); i++) // everything except the file name
		urlBase += urlSplit[i] + "/";
	url = urlBase + "rules0.php?focus=" + resid; 
	
	$.get(url,
	function(result){
		if (v > 4) console.log("result returned from " + url + "\n " + result);
		 // process rule data
		resultData = JSON.parse(result); // global for download
		if (showEm) showRules(resultData);
	});
}
	
function showRules(data) {
	var resID = data['residue_id'];
	var resStructure = data['structure'];
	var snfgImgRef = "../snfg_images/" + data['snfg_name'] + ".svg";
	var resultStr = "<h2>Established Inferences for Residue " + resID + " <img src=\"" + snfgImgRef +
		 "\"> " + resStructure + "</h2>";
	
	var instances = [];
	if (data['rule_instances'].length == 0) {
		resultStr += "<b>" + data['message'] + "</b>";
	} else {
		resultStr += "<table id='rules_table'>\n  ";
		resultStr += "<tr><th>Inference</th><th>References</th><th>Comment</th><th>Status</th></tr>";
		for (var i = 0; i < data['rule_instances'].length; i++) {
			var focus = data['rule_instances'][i]['focus'];
			var ruleInference = data['rule_instances'][i]['inference'];
			var ruleRef = data['rule_instances'][i]['refs'];
			var ruleComment = data['rule_instances'][i]['comment'];
			var ruleStatus = data['rule_instances'][i]['status'];
			resultStr += "<tr><td style='white-space: nowrap'>" + ruleInference +
				"</td><td>" + ruleRef + "</td><td>" + ruleComment + "</td><td>" +
				ruleStatus + "</td></tr>\n  ";
		}
		resultStr += "</table>\n  ";
	}

	$("#ruleDiv").html(resultStr);
	fetchList(resID);
}
	
	
function getRuleLogic(ruleID) {
	// required because rules are in a regular array (not an associative array)
	var ruleLogic = "";
	for (var i = 0; i < resultData['rules'].length; i++) {
		if (resultData['rules'][i]['rule_id'] == ruleID) {
			ruleLogic = resultData['rules'][i]['logic'];
		}
	}
	return(ruleLogic);
}
	
function continue4() {
	// submit all saved rules
	var confirmStr = "Are you sure you want to submit the new rules to the server?\n" +
		 "This will clear all of the data in the (local) submission list.";
		
	if (confirm(confirmStr)) {	
		var curator = prompt("Please enter your curator ID", "");
		var pw = prompt("Please enter your curator password", "");
		allRules['curator'] = curator;
		allRules['curator_pw'] = pw;
		if (v > 3) console.log(allRules);
		jsonRules = JSON.stringify(allRules);
		$.get(submitPath,
		{
			json_data: jsonRules
		},
		function(result){
			if (v > 3) {
				console.log("  submitted data to " + submitPath + "\n" + jsonRules + "\n  " + result);
			}
			// var responseStr = "<h3>Server Response:</h3><pre style='text-align: left;'>" + result + "</pre>";
			// var sd = $("#iDiv");
			// $("#iDiv").html(responseStr);
			newRule = null; // object
			newRuleStr = ""; // string
			allRuleStrs = new Array(); // string[]
			allRules = new Object(); // object[]
			allRules['curator'] = "";
			allRules['curator_pw'] = "";
			allRules['data'] = new Array();
			getRules(true);
		});
	} else {
		alert("No data sent to server");
	} 
	var sd = $("#iDiv");
	sd.html("");
}
	
function showRuleList() {
	var sd = $("#iDiv");
	if (allRuleStrs.length < 1) {
		$("#iDiv").html("<h2>Rule Submission List is Empty</h2>");
		return;
	}

	var tableData = "<h2>Rule Submission List:</h2><table id='saved_rules'>\n  ";
	for (var i = 0; i < allRuleStrs.length; i++) {
		if (v > 3) console.log(allRuleStrs[i]);
		tableData += "<tr><td>" + allRuleStrs[i] + "</td></tr>\n  ";
	}

	tableData += "</table>\n<br><button id='send' onclick='continue4();'>Submit These Rules to Server</button></p>";
	$("#iDiv").html(tableData);
}
	
function continue3() {
	// (save new rule) push the new rule and rule string to arrays, then show all saved rules
	console.log("saving rule:\n" + newRuleStr);
	$("#continue_3").attr('disabled', true);
	allRules['data'].push(newRule);
	allRuleStrs.push(newRuleStr);
	showRuleList();
}
	
function continue2() {
	// instantiate the rule using input fields and generate a string describing it
	$("#continue_2").attr('disabled', true);
	var sd = $("#iDiv");
	// newRule is global
	newRule = {
		rule_id: newRuleID,
		focus: $("#resid").val(),
		agent: $("#rule_agent").val(),
		factor_1: $("#rule_factor_1").val(),
		factor_2: $("#rule_factor_2").val(),
		taxonomy: $("#rule_taxonomy").val(),
		refs: $("#rule_refs").val(),
		comment: $("#rule_comment").val()
	} 
	if (v > 3) console.log(newRule);
	
	var ruleLogic = getRuleLogic(newRuleID);
	var inference = ruleLogic.replace("[focus]", "<b>" + newRule['focus'] + "</b>");
	// newRuleStr is global
	newRuleStr = inference.replace("[agent]", "<b>" + newRule['agent'] + "</b>");
	newRuleStr = newRuleStr.replace("[factor_1]", "<b>" + newRule['factor_1'] + "</b>");
	newRuleStr = newRuleStr.replace("[factor_2]", "<b>" + newRule['factor_2'] + "</b>");
	newRuleStr = newRuleStr.replace("[taxonomy]", "<b>" + newRule['taxonomy'] + "</b>");

	var newRuleParStr = "<br><br><b>References:</b> " + newRule['refs'];
	newRuleParStr += "<br><b>Comment:</b> " + newRule['comment'];
	
	sd.html("<h3>New Application of Rule " + newRuleID + "</h3>" + newRuleStr + newRuleParStr);
	sd.append("<p><button id='continue_3' onclick='continue3();'>Add This Rule to Submission List</button></p>");
}
	
	
function continue1() {
	// enter the parameters for the rule
	$("#continue_1").attr('disabled', true);
	var sd = $("#iDiv");
	var resID = $("#resid").val();
	newRuleID = $('input[name="chosen_rule"]:checked').val(); // global
	var ruleLogic = getRuleLogic(newRuleID);
	/*
	var skipToNextStep = (ruleLogic.search(/(agent|factor|taxonomy)/) == -1);
	if  (skipToNextStep) {
		continue2();
		return;
	}
	*/

	var inference = ruleLogic.replace("[focus]", resID);
	if (v > 3) console.log("Rule " + newRuleID + " applied to " + resID + "\n" + inference);
	var ruleInput = inference.replace("[agent]", "<input type='text' id='rule_agent' size='12'>");
	ruleInput = ruleInput.replace("[factor_1]", "<input type='text' id='rule_factor_1' size='12'>");
	ruleInput = ruleInput.replace("[factor_2]", "<input type='text' id='rule_factor_2' size='12'>");
	ruleInput = ruleInput.replace("[taxonomy]", "<input type='text' id='rule_taxonomy' size='12'>");
	
	ruleInput += "<br><label for=\"rule_refs\">Literature references for the rule:</label>";
	ruleInput += "<br><input type='text' id='rule_refs' size='96'>";
	ruleInput += "<br><label for=\"rule_comment\">Curator comments for the rule:</label>";
	ruleInput += "<br><input type='text' id='rule_comment' size='96'>";
	
	var divHTML = "<h2>Enter any additional values required to implement the rule</h2>";
	divHTML += ruleInput;
	divHTML += "<p><button id=\"continue_2\" onclick=\"continue2();\">Continue</button></p>";
	sd.html(divHTML);
}
	
	
function generateRule() {
	// display a list of rules to choose from
	getRules(false);
	var resID = $("#resid").val();
	var sd = $("#iDiv");
	var ruleStr = "<h2>Select a Rule to apply to Residue " + resID + "</h2>";
	ruleStr += "<table id='rule_select_table'>\n";
	for (var i = 0; i < resultData['rules'].length; i++) {
		var ruleID = resultData['rules'][i]['rule_id'];
		var ruleLogic = resultData['rules'][i]['logic'];
		ruleLogic = ruleLogic.replace("[focus]", resID);
		ruleStr += "  <tr><td><input type=\"radio\" id=\"rule" +
			ruleID + "\" name=\"chosen_rule\" value=\"" + ruleID + "\">" +
			" <label for=\"rule" + ruleID + "\">" + ruleLogic + "</label>"
			"</td></tr>\n"
	}
	ruleStr += "</table>\n";
	ruleStr += "<p><button id=\"continue_1\" onclick=\"continue1();\">Continue</button></p>";
	sd.html(ruleStr);
}
	
</script>
		
</head>

<body onLoad=initialize();>
	
<div id="header" width=100%>
<span id="header_1">GlyGen</span>
<object id="logo_svg" type="image/svg+xml" data="../svg/sbLogo.svg" class="logo"></object>
<span id="header_2">Sand Box</span>
</div>


<div id="imgDiv">
<h2>Curate Rules for Canonical Residues</h2>
	
<label for="resid">Enter a canonical residue id:</label>
<input type="text" id="resid" name="resid" size="5" value="N224"> 
<button id="check_it">Check Rules</button>
<br>
<button id="generate_rule">Apply a New Rule to This Residue</button>
<button id="show_rule_list">Show Rule Submission List</button>
<div id="ruleDiv"></div>	
	<div id="iDiv">Structures will appear here<br></div>
	
</div>
  
<div id="listDiv" style="visibility: visible">
</div>

</body>
</html>
